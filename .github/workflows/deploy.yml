name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Build
      run: |
        cd backend/app
        mvn clean package -DskipTests
        
    - name: Test
      run: |
        cd backend/app
        mvn test
        
    - name: Deploy JAR to Server
      if: success()
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USERNAME }}
        key: ${{ secrets.AWS_PRIVATE_KEY }}
        source: "backend/app/target/api-server-1.0.jar"
        target: "/tmp/"
        strip_components: 3
        
    - name: Restart Application
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USERNAME }}
        key: ${{ secrets.AWS_PRIVATE_KEY }}
        script: |
          set -e
          
          APP_DIR="backend/app/target"
          JAR_NAME="api-server-1.0.jar"
          
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          if [ -f "$JAR_NAME" ]; then
            cp $JAR_NAME ${JAR_NAME}.backup
          fi
          
          mv /tmp/$JAR_NAME $JAR_NAME
          
          OLD_PID=$(pgrep -f "$JAR_NAME" || echo "")
          
          nohup java -jar $JAR_NAME \
            -Dspring.profiles.active=prod \
            > app.log 2>&1 &
          NEW_PID=$!
          
          sleep 15
          
          MAX_ATTEMPTS=12
          ATTEMPT=0
          HEALTH_OK=false
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              HEALTH_OK=true
              break
            fi
            sleep 5
            ATTEMPT=$((ATTEMPT+1))
          done
          
          if [ "$HEALTH_OK" = true ]; then
            if [ -n "$OLD_PID" ]; then
              kill $OLD_PID || true
              sleep 2
              kill -9 $OLD_PID 2>/dev/null || true
            fi
            exit 0
          else
            tail -50 app.log
            
            kill $NEW_PID 2>/dev/null || true
            sleep 2
            kill -9 $NEW_PID 2>/dev/null || true
            
            if [ -f "${JAR_NAME}.backup" ]; then
              mv ${JAR_NAME}.backup $JAR_NAME
              
              nohup java -jar $JAR_NAME \
                -Dspring.profiles.active=prod \
                > app.log 2>&1 &
              
              sleep 10
            fi
            
            exit 1
          fi